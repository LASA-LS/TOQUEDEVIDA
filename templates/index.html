<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Que no SENOS olvide cuidarnos ¬∑ Galer√≠a & Votaci√≥n</title>
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
  <style>
    :root{ --pink:#e91e63; --rose:#ff7aa8; --rose2:#ffd6e7; --wine:#ad1457; --bg:#fff6fa; --ink:#402236; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:#ffffff;color:var(--ink)}
    header{position:relative; padding:10px 16px; color:#fff; background:#ffffff; overflow:hidden;}
    header .bar{max-width:1600px;margin:auto;padding:8px 16px;display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;background:#fff}
    header .brand{display:flex;align-items:center;gap:14px}
    header .brand img.logo{height:46px;filter: drop-shadow(0 4px 12px rgba(0,0,0,.25));}
    header h1{margin:0;font-size:clamp(18px,3vw,28px)}
    .tagline a{color:#fff;text-decoration:underline}
    nav a{color:#fff;text-decoration:none;font-weight:800;margin-left:12px}
    main{max-width:1600px;margin:16px auto;display:grid;grid-template-columns:1.3fr .7fr;gap:16px;padding:0 16px}
    @media (max-width:980px){ main{grid-template-columns:1fr} }

    .card{background:#fff;border-radius:18px;box-shadow:0 12px 30px rgba(233,30,99,.15);padding:18px}
    .card h2{margin:0 0 10px;color:var(--wine)}

    .toplist{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px}
    .topitem{background:#ffffff;border-radius:14px;padding:10px;display:grid;gap:6px}
    .topitem img{width:100%;height:120px;object-fit:cover;border-radius:10px}
    .topmeta{display:flex;justify-content:space-between;align-items:center;font-weight:900}

    .carousel{position:relative; overflow:hidden; border-radius:12px}
    .track{display:flex; gap:10px; overflow-x:auto; scroll-snap-type:x mandatory; padding:10px 2px 14px}
    .track::-webkit-scrollbar{height:8px}
    .track::-webkit-scrollbar-thumb{background:var(--rose2);border-radius:999px}
    .slide{flex:0 0 18%; max-width:18%; scroll-snap-align:center; position:relative; border-radius:16px; overflow:hidden; background:#fff; box-shadow:0 8px 24px rgba(0,0,0,.08); outline:4px solid #fff; outline-offset:-4px;}
    @media (min-width:1100px){ .slide{flex-basis:22%; max-width:22%} }
    .slide img{width:100%;height:300px;object-fit:cover;display:block;filter:saturate(1.02) contrast(1.01)}
    .overlay{position:absolute; inset:auto 0 0 0; padding:10px; background:rgba(255,255,255,.95); color:#7a2c45; display:grid; gap:6px;}
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .tag{background:rgba(255,255,255,.9);color:#7a2c45;border-radius:999px;padding:2px 8px;font-size:11px;font-weight:900}
    .meta{font-size:12px;opacity:.95}
    .votesWrap{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
    .vote{display:inline-flex;gap:6px;align-items:center;background:#e91e63;color:#fff;border:1px solid rgba(0,0,0,.04);border-radius:999px;padding:6px 10px;font-weight:900;transition:transform .2s ease;font-size:12px;box-shadow:0 2px 8px rgba(233,30,99,.28)}
    .vote:hover{transform:translateY(-2px)}
    .votes{font-weight:900}

    .uploader{border:2px dashed #f5a8c3;border-radius:14px;padding:16px;text-align:center;background:#fff8fb;cursor:pointer}
    .uploader:hover{background:#fff1f7} .uploader input{display:none}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:640px){.row{grid-template-columns:1fr}}
    label{display:block;font-weight:700;margin:.25rem 0 .25rem;color:#7a2c45}
    input[type=text], textarea{width:100%;padding:12px 14px;border:1.5px solid #f3c4d6;border-radius:12px;outline:none;background:#fff}
    input[type=text]:focus, textarea:focus{border-color:var(--rose);box-shadow:0 0 0 3px rgba(240,98,146,.18)}
    textarea{min-height:60px;resize:vertical}
    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    button{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
    .primary{background:#f06292;color:#fff;box-shadow:0 6px 16px rgba(240,98,146,.24);padding:10px 14px;border-radius:10px;font-size:14px}
    .ghost{background:#ffe4ef;color:#7a2c45;padding:8px 12px;border-radius:10px;font-size:13px}
  .btn-primary{display:inline-block;padding:12px 18px;border-radius:999px;background:#e91e63;color:#fff;text-decoration:none;font-weight:800;box-shadow:0 8px 20px rgba(233,30,99,.25)}.btn-primary:hover{filter:brightness(.95)}

.decor-wrap{position:fixed; inset:0; pointer-events:none; z-index:-1}
.decor-wrap img{position:absolute; opacity:.09}
.decor-wrap .tl{left:-40px; top:-20px; width:320px}
.decor-wrap .tr{right:-30px; top:80px; width:280px}
.decor-wrap .br{right:-20px; bottom:-30px; width:360px}
@media (max-width: 768px){
  .decor-wrap img{opacity:.06}
  .decor-wrap .tl{width:200px; left:-20px; top:-10px}
  .decor-wrap .tr{width:180px; right:-10px; top:60px}
  .decor-wrap .br{width:220px; right:-10px; bottom:-10px}
}


@media (max-width: 1400px){ .slide{flex-basis:20%; max-width:20%} }
@media (max-width: 1200px){ .slide{flex-basis:24%; max-width:24%} }
@media (max-width: 992px){ .slide{flex-basis:30%; max-width:30%} }
@media (max-width: 768px){ .slide{flex-basis:45%; max-width:45%} }
@media (max-width: 480px){ .slide{flex-basis:100%; max-width:100%} }

.reg-extra{display:grid;gap:8px;margin-top:8px}
.camp-logo{height:140px;width:auto;display:block}@media (max-width:768px){.camp-logo{height:88px}}
/* Fondo con flores sutil */
.bg-flowers{position:fixed;inset:0;pointer-events:none;z-index:-2}
.bg-flowers img{position:absolute;opacity:.07}
.bg-flowers .fl-tl{left:-24px;top:-16px;width:280px}
.bg-flowers .fl-cr{right:6vw;top:22vh;width:360px}
.bg-flowers .fl-bl{left:2vw;bottom:2vh;width:340px}
@media(max-width:768px){.bg-flowers img{opacity:.05}.bg-flowers .fl-tl{width:180px}.bg-flowers .fl-cr{width:220px}.bg-flowers .fl-bl{width:220px}}
.btn-primary{display:inline-block;padding:12px 18px;border-radius:999px;background:#e91e63;color:#fff;text-decoration:none;font-weight:800;box-shadow:0 8px 20px rgba(233,30,99,.25)}.btn-primary:hover{filter:brightness(.95)}.btn-primary.small{padding:8px 12px;font-size:13px}
</style>
</head>
<body>
  <div class="bg-flowers">
    <img src="{{ url_for('static', filename='flower_corner.png') }}" class="fl-tl" alt="">
    <img src="{{ url_for('static', filename='flower_2.png') }}" class="fl-cr" alt="">
    <img src="{{ url_for('static', filename='flower_1.png') }}" class="fl-bl" alt="">
  </div>

  <div class="decor-wrap">
    <img src="{{ url_for('static', filename='decor_flower1.png') }}" class="tl" alt="">
    <img src="{{ url_for('static', filename='decor_flower2.png') }}" class="tr" alt="">
    <img src="{{ url_for('static', filename='decor_corner.png') }}" class="br" alt="">
  </div>

  <header>
    <div class="bar">
      
    <div class="brand" style="text-align:center;">
      <img src="{{ url_for('static', filename='logo-toquevida.png') }}" alt="Toque de vida ‚Äì La prevenci√≥n est√° en tus manos" style="max-height:110px;width:auto;">
    </div>
    
        </div>
      </div>
      <nav><a href="/">Galer√≠a</a> ¬∑ <a href="/sopa" target="_blank">Sopa de letras</a></nav>
    </div>
  </header>
        

  <main>
    <section class="card">
      <h2>üèÜ Top 5 (en vivo)</h2>
      <div id="toplist" class="toplist"></div>

      <h2 style="margin-top:14px">Galer√≠a (mini carrusel)</h2>
      <div class="carousel">
        <div id="track" class="track"></div>
      </div>
    </section>

    <aside class="card">
      <h2>Registra tu equipo</h2>
<div class="cta-form" style="display:flex;justify-content:flex-end;margin:-2px 0 8px 0"><a class="btn-primary small" href="{{ url_for('static', filename='bases_concurso.pdf') }}" target="_blank" rel="noopener">Ver bases del concurso</a></div>

      <form id="form" enctype="multipart/form-data">
        <div class="row">
          <div>
            <label>Equipo</label>
            <input type="text" name="equipo" placeholder="Guerreras Rosa">
<div class="reg-extra">
  <label>Participantes (m√°x. 5, separados por coma; incluir n√∫mero de empleado)</label>
  <input type="text" name="participantes" placeholder="Nombre1 12345, Nombre2 23456, ..." required>
  <label>Departamento</label>
  <input type="text" name="departamento" placeholder="Ej. Ventas, RH" required>
  <label>Correo electr√≥nico</label>
  <input type="email" id="correo" name="correo" placeholder="correo@empresa.com" required>
  <input type="hidden" id="dato" name="dato">
</div>

          </div>
          <div>
            <label>Hashtag</label>
            <input type="text" name="hashtag" placeholder="#ChequeoEsPrevenci√≥n" value="#ChequeoEsPrevenci√≥n">
          </div>
        </div><input id="file" type="file" name="poster" accept="image/*">
          <strong>Arrastra tu foto aqu√≠</strong> o haz clic para seleccionar. <span style="color:#7a2c45;font-size:13px">(JPG/PNG/WEBP)</span>
        </label>
        <div class="actions">
          <button class="primary" type="submit">üíñ Subir foto</button>
          <button class="ghost" type="button" id="refreshBtn">üîÑ Actualizar</button>
        </div>
        <div id="status" style="margin:8px 0 0;font-size:13px;color:#7a2c45"></div>
      </form>
    </aside>
  </main>

  <script>
    const categories = ['creatividad','mensaje','equipo'];
    const labels = {creatividad:'Creatividad', mensaje:'Mensaje', equipo:'Trabajo en equipo'};
    const emojis = {creatividad:'üé®', mensaje:'üí¨', equipo:'ü§ù'};

    const toplist = document.getElementById('toplist');
    const track = document.getElementById('track');
    const form = document.getElementById('form');
    const refreshBtn = document.getElementById('refreshBtn');

    async function fetchList(){
      const r = await fetch('/api/list');
      const j = await r.json();
      if(!j.ok) return;
      renderTop(j.top5);
      renderCarousel(j.items);
    }

    function renderTop(items){
      toplist.innerHTML = items.map(it => `
        <div class="topitem">
          <img src="/uploads/${it.filename}" alt="${it.equipo}">
          <div class="topmeta">
            <div style="display:grid">
              <span>${it.equipo}</span>
              <small style="opacity:.8">${it.participantes? 'üë• '+it.participantes:''}</small>
            </div>
            <strong>‚≠ê ${it.total}</strong>
          </div>
        </div>
      `).join('');
    }

    function slideTpl(it){
      const url = `/uploads/${it.filename}`;
      const team = it.equipo || 'Equipo Rosa';
      const lema = it.lema || '';
      const tag = it.hashtag || '';
      const dato = it.dato || '';
      const participantes = it.participantes || '';
      return `
      <article class="slide">
        <img src="${url}" alt="${team}">
        <div class="overlay">
          <div class="tags">
            ${tag ? `<span class="tag">${tag}</span>` : ''}
            </div>
          <div style="display:flex;align-items:center;justify-content:space-between;gap:6px">
            <div>
              <div style="font-weight:900;font-size:16px">${team}</div>
              ${lema ? `<div style="opacity:.95;font-size:13px">${lema}</div>`: ''}
            </div>
            <div class="votesWrap">
              ${categories.map(c => voteBtn(it.filename, c)).join('')}
            </div>
          </div>
        </div>
      </article>`;
    }

    function voteBtn(filename, category){
      return `<button class="vote" data-filename="${filename}" data-category="${category}" title="Votar ${labels[category]}">
        <span>${emojis[category]}</span><span class="votes" data-count="0">0</span>
      </button>`;
    }

    function renderCarousel(items){
      track.innerHTML = items.map(slideTpl).join('');
      bindVoteButtons(track);
    }

    function bindVoteButtons(root){
      root.querySelectorAll('.vote').forEach(btn=>{
        btn.onclick = async ()=>{
          const filename = btn.getAttribute('data-filename');
          const category = btn.getAttribute('data-category');
          if(!filename || !category) return;
          const key = `voted_${category}_`+filename;
          if(localStorage.getItem(key)){
            btn.style.transform = 'scale(0.98)';
            return;
          }
          const fd = new FormData();
          fd.append('filename', filename);
          fd.append('category', category);
          const r = await fetch('/api/vote', {method:'POST', body: fd});
          const j = await r.json();
          if(j.ok){
            const parent = btn.closest('.votesWrap');
            categories.forEach(c=>{
              const b = parent.querySelector(`.vote[data-category="${c}"] .votes`);
              if(b && j.votes[c] != null){ b.textContent = j.votes[c]; }
            });
            localStorage.setItem(key, '1');
          }
        };
      });
    }

    form.onsubmit = async (e)=>{
      e.preventDefault();
      const fd = new FormData(form);
      const file = fd.get('poster');
      if(!file || !file.name){
        alert('Selecciona una imagen.');
        return;
      }
      const r = await fetch('/api/submissions', {method:'POST', body: fd});
      const j = await r.json();
      if(j.ok){
        form.reset();
        fetchList();
      }else{
        alert(j.error || 'No se pudo subir.');
      }
    };

    refreshBtn.onclick = fetchList;
    fetchList();
    setInterval(fetchList, 30000);

    async function updateStatus(){
      try{
        const r = await fetch('/api/meta'); const j = await r.json();
        const el = document.getElementById('status');
        if(!el) return;
        if(j.state==='pre'){
          el.innerHTML = '‚åõ La recepci√≥n abre el ' + new Date(j.open).toLocaleString();
        } else if(j.state==='open'){
          el.innerHTML = '‚úÖ Recepci√≥n abierta hasta ' + new Date(j.close).toLocaleString();
        } else {
          el.innerHTML = '‚õî Recepci√≥n cerrada. Env√≠a tu foto por correo a <a href="mailto:'+j.service_email+'">'+j.service_email+'</a>.';
        }
      }catch(e){}
    }
    updateStatus();
    setInterval(updateStatus, 60000);
  </script>
<script>
function mirrorCorreoDato(){
  var c=document.getElementById('correo'), d=document.getElementById('dato');
  if(c && d){ d.value = c.value; }
}
document.addEventListener('input', function(e){ if(e.target && e.target.id==='correo'){ mirrorCorreoDato(); } });
document.addEventListener('DOMContentLoaded', mirrorCorreoDato);
</script>
<footer style="background:#fff;border-top:1px solid #f2e4ec;display:flex;justify-content:center;align-items:center;padding:14px 16px;margin-top:10px"><img src="{{ url_for('static', filename='logo-servicio-medico.png') }}" alt="Servicio M√©dico La Coste√±a" style="height:80px;max-width:92vw"></footer>
</body>
</html>
